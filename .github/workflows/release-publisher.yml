name: Release Drafting and Publishing (PR/Push)

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    types: [opened, synchronize, reopened, edited, closed]
    branches:
      - develop
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  # ----------------------------------------------------------------------
  # 1. DRAFTING JOB
  # ----------------------------------------------------------------------
  draft:
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Checkout the HEAD branch of the PR for stable commit history access
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0 # Ensure full history for accurate drafting

      - name: Determine Config Name
        id: config_path
        run: |
          if [ "${{ github.base_ref }}" == "develop" ]; then
            echo "config_name=release-drafter-develop.yml" >> $GITHUB_OUTPUT
          else
            echo "config_name=release-drafter-main.yml" >> $GITHUB_OUTPUT
          fi

      - name: Draft Release
        uses: release-drafter/release-drafter@v6
        with:
          config-name: ${{ steps.config_path.outputs.config_name }}
          target-commitish: ${{ github.event.pull_request.merge_commit_sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ----------------------------------------------------------------------
  # 2. PUBLISHING JOB (Includes Custom Versioning for Develop)
  # ----------------------------------------------------------------------
  publish-on-label:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'Publish')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        # Checkout the merge commit with full history for 'git describe'
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0 # <--- CRITICAL: Required for git describe to see all tags

      - name: Determine Config and Prerelease Status
        id: config_path
        run: |
          BASE_REF=${{ github.event.pull_request.base.ref }}
          if [ "$BASE_REF" == "develop" ]; then
            echo "config_name=release-drafter-develop.yml" >> $GITHUB_OUTPUT
            echo "prerelease_status=true" >> $GITHUB_OUTPUT
            echo "is_develop=true" >> $GITHUB_OUTPUT
          else
            echo "config_name=release-drafter-main.yml" >> $GITHUB_OUTPUT
            echo "prerelease_status=false" >> $GITHUB_OUTPUT
            echo "is_develop=false" >> $GITHUB_OUTPUT
          fi

      # --- NEW STEP: FORCES DEV VERSIONING ---
      - name: Calculate Next DEV Version (Bypassing Global Fallback)
        if: steps.config_path.outputs.is_develop == 'true'
        id: dev_versioning
        run: |
          # Use git describe to find the last tag starting with 'dev-v'
          # If no tag is found, default to 'dev-v0.0.0'
          LAST_TAG=$(git describe --tags --match 'dev-v*' --abbrev=0 --candidates=10 2>/dev/null || echo 'dev-v0.0.0')
          
          # Extract the version number (e.g., '0.0.0' from 'dev-v0.0.0')
          VERSION_STRING=$(echo $LAST_TAG | sed 's/dev-v//')
          
          # Calculate next patch version (e.g., 0.0.0 -> 0.0.1)
          # We use awk to ensure correct mathematical increment
          NEXT_VERSION=$(echo $VERSION_STRING | awk -F. '{print $1"."$2"."$3+1}')

          echo "Last unique dev tag found: $LAST_TAG"
          echo "Calculated next independent version: $NEXT_VERSION"
          echo "next_dev_version=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: Create/Update Final Draft (using merge commit)
        id: create_draft
        uses: release-drafter/release-drafter@v6
        with:
          config-name: ${{ steps.config_path.outputs.config_name }}
          # CRITICAL CHANGE: Pass the custom calculated version if on develop
          next-version: ${{ steps.config_path.outputs.is_develop == 'true' && steps.dev_versioning.outputs.next_dev_version || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Publish Release using Draft ID
        if: steps.create_draft.outputs.id
        run: |
          echo "Publishing release ${{ steps.create_draft.outputs.name }} (ID: ${{ steps.create_draft.outputs.id }})"
          # Use gh CLI to update the draft, setting draft=false and setting prerelease status
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/releases/${{ steps.create_draft.outputs.id }} \
            -f draft=false \
            -f prerelease=${{ steps.config_path.outputs.prerelease_status }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
